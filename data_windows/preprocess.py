import csv
from sklearn.model_selection import train_test_split
import random
from data_utils import define

MAX = 1000
MIN = 15

def readcsv(fn, malware=None, start=1):
    csv_reader = csv.reader(open(fn))
    data = []
    sfw = []
    if malware != None:
        mw = [[] for i in range(len(malware))]
        mwlable = [[] for i in range(len(malware))]
    for row in csv_reader:
        if row not in sfw:
            sfw.append(row)
            _data = row[start:]

            apis = []
            try:
              pre = _data[start]
            except:
              #print('size',row)
              continue
            apis.append(pre)
            for api in _data:
                 if api != pre:
                    apis.append(api)
                 pre = api
            if (len(api) < 15 or len(api) > MAX):
                 #print(len(api))
                 continue
            _data = apis

            if malware != None:
                _t = row[0].split('.')[0].lower()
                if _t in malware:
                      mw[malware.index(_t)].append(_data)
                      mwlable[malware.index(_t)].append(malware.index(_t))
                elif len(_t)!=0:
                   for i in range(len(malware)):
                      m = malware[i]
                      if (_t.find(m) != -1 and _t.find('not-a-virus') == -1):
                          mw[i].append(_data)
                          mwlable[i].append(i)
                          break        
            else:
                data.append(_data)
        else:
            #print('repeat:',row[0])
            break
    if malware != None:
        return mw,mwlable
    return data

def writevoc(X):
    flattened  = [val for sublist in X for val in sublist]
    ids = list(set(flattened))
    voc = {"PAD": 0, "_GO": 1,  "_EOS": 2,  "_UNK": 3,}
    i = 4
    for id in ids:
         voc[id] = i
         i += 1
    import json
    fp2=open('voc.json','w')
    json.dump(voc, fp2)
   
def writeseq(fn, X, Y):
    with open(fn, 'w', newline = '') as f:
       writer = csv.writer(f,delimiter = ' ')
       for x,y in zip(X, Y):
            x.append(y)
            writer.writerow(x)
       f.close()

if __name__ == '__main__':
    config  = define()
    
    benign = readcsv('apiseq_benign.csv')
    malware = readcsv('apiseq_malware.csv')
    '''
    malware,label = readcsv('apiseq_malware.csv',config.key())
    malware2,label2 = readcsv('malware_API_dataset.csv',config.key(),2)

    for i in range(len(mwlist)):
       if len(malware2[i]) != 0:
           malware[i].extend(malware2[i])
           label[i].extend(label2[i])
    for i in malware:
      print(len(i))
    '''
    malware = random.sample(malware, len(benign))
    print(len(benign),len(malware))

    #y1 = [len(mwlist)]*len(benign)
    #y2 = [len()]
    y1 = [1]*len(benign)
    y2 = [0]*len(malware)
    X = benign + malware
    Y = y1 + y2
    writevoc(X)
    X_train , X_test , y_train,y_test = train_test_split(X, Y, test_size=0.3, stratify=Y)
    writeseq('train.seq',X_train, y_train)
    writeseq('valid.seq',X_test, y_test)



