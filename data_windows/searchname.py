import csv
import random
from data_utils import malware_label,benign_label


def readcsv(fn, start=2):
    csv_reader = csv.reader(open(fn))
    data = []
    sfw = []
    lens = []
    for row in csv_reader:
         if row[1] not in sfw:
             sfw.append(row[1])
             _data = row[start:]
             ## do repeat api
             apis = []
             pre = _data[start-1]
             apis.append(pre)
             for api in _data:
                if api != pre:
                   apis.append(api)
                pre = api
             _data = apis
             ## end
             if len(_data) < 15 or len(_data) > 100000:
                continue
             lens.append(len(_data))
             data.append(_data)
         else:
             print(row[1])
    print(fn, max(lens), min(lens),len(data))
    return data

mwlist = ['apiseq_all_Backdoor.csv','apiseq_all_Trojan-Downloader.csv','apiseq_all_Trojan-Ransom.csv','apiseq_all_AdWare.csv','apiseq_all_Worm.csv']
malware = []
for i in mwlist:
   malware.append(readcsv(i))

def writeseq(fn, X, Y):
    with open(fn, 'w', newline = '') as f:
       writer = csv.writer(f,delimiter = ' ')
       for x,y in zip(X, Y):
            x.append(y)
            writer.writerow(x)
       f.close()
'''
for m in range(5):
   mlabel = [malware_label]*len(malware[m])
   writeseq(mwlist[m]+'_valid.seq',malware[m], mlabel)

'''
def readcsv2(fn, start=0):
    csv_reader = open(fn, 'r')
    malware = []
    benign = []
    lens = []
    for row in csv_reader:
             row = row.strip('\n').split(' ')
             _data = row[start:-1]
             lens.append(len(_data))
             if (int(row[-1]) == benign_label):
                benign.append(_data)
             else:
                malware.append(_data)
    print(fn, max(lens), min(lens), len(malware),len(benign))
    return malware,benign

mal, beg = readcsv2('valid.seq')

res = []
for i in range(5):
   print(mwlist[i])
   ml = malware[i]
   _tmp = []
   for m1 in mal:
    for m2 in ml:
     #print(len(m1), len(m2))
     if m1 == m2:
        _tmp.append(m1)
   res.append(_tmp)

print([len(a) for a in res])



for m in range(5):
   mlabel = [malware_label]*len(res[m])
   writeseq(mwlist[m]+'_valid.seq',res[m], mlabel)
