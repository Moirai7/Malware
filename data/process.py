import csv
from sklearn.model_selection import train_test_split
import random
from data_utils import define


def readcsv(fn, start=1):
    csv_reader = csv.reader(open(fn))
    data = []
    sfw = []
    for row in csv_reader:
         if row not in sfw:
             sfw.append(row)
             _data = row[start:]
             ## do repeat api
             apis = []
             pre = _data[start-1]
             apis.append(pre)
             for api in _data:
                if api != pre:
                   apis.append(api)
                pre = api
             _data = apis
             ## end
             data.append(_data)
         else:
             print(row[0])
    return data

def writevoc(X):
    flattened  = [val for sublist in X for val in sublist]
    ids = list(set(flattened))
    voc = {"PAD": 0, "_GO": 1,  "_EOS": 2,  "_UNK": 3,}
    i = 4
    for id in ids:
         voc[id] = i
         i += 1
    import json
    fp2=open('voc.json','w')
    json.dump(voc, fp2)


def writeseq(fn, X, Y):
    with open(fn, 'w', newline = '') as f:
       writer = csv.writer(f,delimiter = ' ')
       for x,y in zip(X, Y):
            x.append(y)
            writer.writerow(x)
       f.close()

if __name__ == '__main__':
     benign = readcsv('apiseq_benign.csv')
     mwlist = ['apiseq_all_AdWare.csv','apiseq_all_Backdoor.csv','apiseq_all_Trojan-Downloader.csv','apiseq_all_Trojan-Ransom.csv','apiseq_all_Worm.csv']
     malware = []
     for i in mwlist:
         malware.extend(readcsv(i))

     malware = sorted(malware, key = lambda a: len(a))
     malware = malware[0:len(benign)]

     config  = define()
     blabel = [config['benign']]*len(benign)
     mlabel = [config['malware']]*len(malware)
     print(len(benign),len(malware))

     X = benign + malware
     Y = blabel + mlabel
     writevoc(X)
     X_train , X_test , y_train,y_test = train_test_split(X, Y, test_size=0.3, stratify=Y)
     writeseq('train.seq',X_train, y_train)
     writeseq('valid.seq',X_test, y_test)
